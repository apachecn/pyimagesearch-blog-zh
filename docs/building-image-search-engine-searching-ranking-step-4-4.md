# 构建图像搜索引擎:搜索和排序(第 4 步，共 4 步)

> 原文：<https://pyimagesearch.com/2014/02/24/building-image-search-engine-searching-ranking-step-4-4/>

我们现在处于构建图像搜索引擎的最后一步——接受查询图像并执行实际搜索。

让我们花点时间回顾一下我们是如何走到这一步的:

*   **[第一步:定义你的图像描述符](https://pyimagesearch.com/2014/02/03/building-an-image-search-engine-defining-your-image-descriptor-step-1-of-4/ "Step 1: Defining Your Image Descriptor.")** 。在我们考虑建立一个图像搜索引擎之前，我们需要考虑如何仅使用一系列数字(即特征向量)来表示和量化我们的图像。我们探索了图像的三个容易描述的方面:颜色、纹理和形状。我们可以使用这些方面中的一个，或者多个。
*   **[第二步:索引你的数据集](https://pyimagesearch.com/2014/02/10/building-an-image-search-engine-indexing-your-dataset-step-2-of-4/ "Step 2: Indexing Your Dataset")** 。现在我们已经选择了一个描述符，我们可以应用该描述符从数据集中的每个图像中提取特征。从影像数据集中提取特征的过程称为“索引”。这些特性随后被写入磁盘供以后使用。索引也是一项任务，通过利用我们机器上的多个内核/处理器，可以很容易地实现并行。
*   **[第三步:定义你的相似性度量](https://pyimagesearch.com/2014/02/17/building-an-image-search-engine-defining-your-similarity-metric-step-3-of-4/ "Step 3: Defining Your Similarity Metric.")** 。在步骤 1 中，我们定义了一种从图像中提取特征的方法。现在，我们需要定义一种方法来比较我们的特征向量。距离函数应该接受两个特征向量，然后返回一个指示它们有多“相似”的值。相似性函数的常见选择包括(但不限于)欧几里德距离、曼哈顿距离、余弦距离和卡方距离。

最后，我们现在准备执行构建图像搜索引擎的最后一步:**搜索和排名**。

# 该查询

在执行搜索之前，我们需要一个查询。

上次你去谷歌的时候，你在搜索框里输入了一些关键词，对吗？您输入到输入表单中的文本就是您的“查询”。

然后，谷歌获取你的查询，对其进行分析，并将其与庞大的网页索引进行比较，对其进行排序，然后将最相关的网页返回给你。

同样，当我们构建一个图像搜索引擎时，我们需要一个查询图像。

查询图像有两种风格:一种是*内部*查询图像，另一种是*外部*查询图像。

顾名思义，内部查询图像已经属于我们的索引。我们已经对它进行了分析，从中提取了特征，并存储了它的特征向量。

第二种类型的查询图像是外部查询图像。这相当于把我们的文本关键词输入谷歌。我们以前从未见过这个查询图像，因此无法对其做出任何假设。我们简单地应用我们的图像描述符，提取特征，根据与查询的相似性对索引中的图像进行排序，并返回最相关的结果。

你可能还记得，当我写关于构建你的第一个图像搜索引擎的指南时，我包括了对内部和外部查询的支持。

我为什么这么做？

让我们回想一下我们的相似性度量，假设我们使用的是欧几里德距离。欧几里德距离有一个很好的属性，叫做重合公理，意味着当且仅当两个特征向量相同时，函数返回值 0(表示完全相似)。

如果我要搜索已经在我的索引中的图像，那么两个特征向量之间的欧几里德距离将为零，这意味着完全相似。这张图片将被放在我的搜索结果的顶部，因为它是最相关的。这是有意义的，也是预期的行为。

如果我搜索一张已经在我的索引中的图片，却没有在#1 结果位置找到它，那该多奇怪啊。这可能意味着我的代码中某处有一个 bug，或者我在图像描述符和相似性度量方面做了一些非常糟糕的选择。

总的来说，使用内部查询图像是一种健全性检查。它可以让你确保你的图像搜索引擎按预期运行。

一旦确认图像搜索引擎工作正常，就可以接受不属于索引的外部查询图像。

# 搜索

那么实际执行搜索的过程是怎样的呢？查看下面的大纲:

## 1.接受来自用户的查询图像

用户可以从他们的桌面或移动设备上传图像。随着图像搜索引擎变得越来越流行，我怀疑大多数查询将来自 iPhones 和机器人等设备。用手机拍下你感兴趣的地方、物体或事物的照片，然后自动分析并返回相关结果，这既简单又直观。

## 2.描述查询图像

现在您已经有了一个查询图像，您需要使用与在索引阶段完全相同的图像描述符来描述它。例如，如果我在索引数据集中的图像时使用每通道 32 个像素的 RGB 颜色直方图，那么在描述查询图像时，我将使用相同的每通道 32 个像素的直方图。这确保了我的图像有一个一致的表现。在应用我的图像描述符之后，我现在有了查询图像的特征向量。

## 3.执行搜索

要执行最基本的搜索方法，您需要遍历索引中的所有特征向量。然后，使用相似性度量将索引中的特征向量与查询中的特征向量进行比较。您的相似性度量将告诉您这两个特征向量有多“相似”。最后，根据相似性对结果进行排序。

如果你想看看“执行搜索”这一步是如何操作的，那就去看看我的[如何构建你的第一个图片搜索引擎帖子](https://pyimagesearch.com/2014/01/27/hobbits-and-histograms-a-how-to-guide-to-building-your-first-image-search-engine-in-python/)。在第 3 步，我给你 Python 代码，可以用来执行搜索。

对于小型数据集，循环遍历整个索引可能是可行的。但是如果你有一个大的图像数据集，比如 Google 或者 TinEye，这是不可能的。您无法计算查询要素与数据集中已有的数十亿个要素向量之间的距离。

对于有信息检索经验的读者(传统上专注于构建文本搜索引擎)，我们也可以使用 tf-idf 索引和倒排索引来加速这个过程。然而，为了使用这种方法，我们需要确保我们的特征能够适合向量空间模型，并且足够稀疏。构建一个利用这种方法的图像搜索引擎超出了本文的范围；然而，将来当我们开始构建更复杂的搜索引擎时，我肯定会再次访问它。

## 4.向用户显示您的结果

现在我们已经有了相关图片的排序列表，我们需要将它们显示给用户。如果用户在桌面上，这可以通过一个简单的网络界面来完成，或者如果用户在移动设备上，我们可以使用某种应用程序来显示图像。在构建图像搜索引擎的整体环境中，这一步相当琐碎，但是您仍然应该考虑用户界面以及用户将如何与您的图像搜索引擎交互。

# 摘要

现在你有了，建立一个图片搜索引擎的四个步骤，从前到后:

1.  定义您的图像描述符。
2.  索引您的数据集。
3.  定义你的相似度。
4.  执行搜索，根据与用户的相关性对索引中的图像进行排序，并向用户显示结果。

那么你是怎么看待这一系列帖子的呢？信息丰富吗？你学到什么了吗？或者你更喜欢有更多代码示例的帖子，比如[霍比特人和直方图](https://pyimagesearch.com/2014/01/27/hobbits-and-histograms-a-how-to-guide-to-building-your-first-image-search-engine-in-python/)？

请在下面留下评论，我很想听听你的想法。

一如既往，请务必在下面注册，下载我的图像搜索引擎资源指南 PDF。你会收到我没有在这个博客上发表的独家提示、技巧和诀窍。你会是第一个知道我即将推出新书的人！